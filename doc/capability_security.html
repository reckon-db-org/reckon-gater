<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="reckon_gater v1.1.2">


    <title>Capability Security — reckon_gater v1.1.2</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-7E236B78.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
reckon_gater
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.1.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of reckon_gater</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Capability-Based Security</h1>


      <a href="https://github.com/reckon-db-org/reckon-gater/blob/v1.1.2/guides/capability_security.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide explains the security model used in the reckon-db ecosystem and how to implement it in your applications.</p><h2 id="prerequisites" class="section-heading"><a href="#prerequisites" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Prerequisites</span></h2><p>Before reading this guide, you should understand:</p><ul><li>Basic event sourcing concepts (<a href="event_sourcing.html">Event Sourcing Guide</a>)</li><li>Public-key cryptography basics (signing, verification)</li><li>The difference between authentication and authorization</li></ul><h2 id="the-problem-centralized-authorization-doesn-t-scale" class="section-heading"><a href="#the-problem-centralized-authorization-doesn-t-scale" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Problem: Centralized Authorization Doesn't Scale</span></h2><p>Traditional security models rely on a central authority:</p><p><img src="assets/auth_traditional.svg" alt="Traditional Authorization"/></p><p><strong>Problems with this approach:</strong></p><ul><li><strong>Single point of failure</strong> - If the auth server is down, nothing works</li><li><strong>Network dependency</strong> - Every request requires a round-trip</li><li><strong>Partition intolerance</strong> - Network splits break authorization</li><li><strong>Scalability bottleneck</strong> - All requests funnel through one service</li></ul><p>In a distributed mesh (like Macula), nodes may be temporarily disconnected. We need authorization that works <strong>offline</strong>.</p><h2 id="the-solution-capability-tokens" class="section-heading"><a href="#the-solution-capability-tokens" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Solution: Capability Tokens</span></h2><p>Capability tokens are <strong>self-proving</strong> - they carry their own authorization:</p><p><img src="assets/auth_capability.svg" alt="Capability Authorization"/></p><p><strong>Benefits:</strong></p><ul><li><strong>No central authority needed</strong> - Any node can verify</li><li><strong>Works offline</strong> - Verification is cryptographic, not network-based</li><li><strong>Delegatable</strong> - Permissions can be passed with attenuation</li><li><strong>Time-bound</strong> - Short TTLs limit damage from compromised tokens</li></ul><h2 id="architecture-overview" class="section-heading"><a href="#architecture-overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Overview</span></h2><p><img src="assets/capability_architecture.svg" alt="Capability Security Architecture"/></p><h3 id="component-responsibilities" class="section-heading"><a href="#component-responsibilities" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Component Responsibilities</span></h3><table><thead><tr><th style="text-align: left;">Component</th><th style="text-align: left;">Location</th><th style="text-align: left;">Responsibility</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">esdb_identity</code></td><td style="text-align: left;">Your Application</td><td style="text-align: left;">Generate keypairs, manage identities</td></tr><tr><td style="text-align: left;"><code class="inline">esdb_capability</code></td><td style="text-align: left;">Your Application</td><td style="text-align: left;">Create, sign, delegate, encode tokens</td></tr><tr><td style="text-align: left;"><code class="inline">esdb_capability_verifier</code></td><td style="text-align: left;">reckon-db Server</td><td style="text-align: left;">Verify signatures, check permissions</td></tr><tr><td style="text-align: left;"><code class="inline">esdb_revocation</code></td><td style="text-align: left;">reckon-db Server</td><td style="text-align: left;">Track revoked tokens</td></tr></tbody></table><p><strong>Key insight:</strong> Token <em>creation</em> happens in your application. Token <em>verification</em> happens on the reckon-db server. reckon-gater provides the types and helpers, but doesn't enforce security.</p><hr class="thin"/><h2 id="part-1-identity-management-your-application" class="section-heading"><a href="#part-1-identity-management-your-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 1: Identity Management (Your Application)</span></h2><p>Identities are Ed25519 keypairs. The public key is encoded as a DID (Decentralized Identifier).</p><h3 id="generate-an-identity" class="section-heading"><a href="#generate-an-identity" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Generate an Identity</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Create a new identity for your service/user</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">include_lib</span><span class="p" data-group-id="1949700104-1">(</span><span class="s">&quot;reckon_gater/include/esdb_capability_types.hrl&quot;</span><span class="p" data-group-id="1949700104-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Generate a new Ed25519 keypair</span><span class="w">
</span><span class="n">Identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">generate</span><span class="p" data-group-id="1949700104-2">(</span><span class="p" data-group-id="1949700104-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% The identity contains:</span><span class="w">
</span><span class="c1">%% - Public key (shareable)</span><span class="w">
</span><span class="c1">%% - Private key (keep secret!)</span><span class="w">
</span><span class="c1">%% - DID (public key encoded as did:key:z...)</span><span class="w">

</span><span class="c1">%% Get the DID for sharing with others</span><span class="w">
</span><span class="n">DID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">did</span><span class="p" data-group-id="1949700104-3">(</span><span class="n">Identity</span><span class="p" data-group-id="1949700104-3">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; &lt;&lt;&quot;did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK&quot;&gt;&gt;</span></code></pre><h3 id="store-identities-securely" class="section-heading"><a href="#store-identities-securely" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Store Identities Securely</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Persist identity across restarts</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% NEVER store private keys in:</span><span class="w">
</span><span class="c1">%% - Version control</span><span class="w">
</span><span class="c1">%% - Environment variables (can leak in logs)</span><span class="w">
</span><span class="c1">%% - Unencrypted files</span><span class="w">

</span><span class="c1">%% DO store private keys in:</span><span class="w">
</span><span class="c1">%% - Hardware security modules (HSM)</span><span class="w">
</span><span class="c1">%% - Encrypted at rest with a master key</span><span class="w">
</span><span class="c1">%% - Secrets management (Vault, AWS Secrets Manager)</span><span class="w">

</span><span class="c1">%% Example: Load from encrypted file</span><span class="w">
</span><span class="nf">load_identity</span><span class="p" data-group-id="5018406711-1">(</span><span class="n">Path</span><span class="p">,</span><span class="w"> </span><span class="n">MasterKey</span><span class="p" data-group-id="5018406711-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5018406711-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Encrypted</span><span class="p" data-group-id="5018406711-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p" data-group-id="5018406711-3">(</span><span class="n">Path</span><span class="p" data-group-id="5018406711-3">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Decrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">crypto_one_time</span><span class="p" data-group-id="5018406711-4">(</span><span class="ss">aes_256_gcm</span><span class="p">,</span><span class="w"> </span><span class="n">MasterKey</span><span class="p">,</span><span class="w"> </span><span class="n">Nonce</span><span class="p">,</span><span class="w"> </span><span class="n">Encrypted</span><span class="p">,</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="5018406711-4">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5018406711-5">{</span><span class="n">PubKey</span><span class="p">,</span><span class="w"> </span><span class="n">PrivKey</span><span class="p" data-group-id="5018406711-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">binary_to_term</span><span class="p" data-group-id="5018406711-6">(</span><span class="n">Decrypted</span><span class="p" data-group-id="5018406711-6">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">from_keypair</span><span class="p" data-group-id="5018406711-7">(</span><span class="n">PubKey</span><span class="p">,</span><span class="w"> </span><span class="n">PrivKey</span><span class="p" data-group-id="5018406711-7">)</span><span class="p">.</span></code></pre><h3 id="why-dids" class="section-heading"><a href="#why-dids" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why DIDs?</span></h3><p>DIDs (Decentralized Identifiers) are a W3C standard for self-sovereign identity. The <code class="inline">did:key</code> method encodes the public key directly in the identifier:</p><pre><code class="makeup erlang" translate="no"><span class="nc">did</span><span class="p">:</span><span class="nc">key</span><span class="p">:</span><span class="ss">z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK</span><span class="w">
        </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w">
        </span><span class="err">│</span><span class="w"> </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Base58btc</span><span class="w"> </span><span class="nf">encoded</span><span class="w"> </span><span class="p" data-group-id="1819907503-1">(</span><span class="ss">multicodec</span><span class="w"> </span><span class="ss">prefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Ed25519</span><span class="w"> </span><span class="ss">public</span><span class="w"> </span><span class="ss">key</span><span class="p" data-group-id="1819907503-1">)</span><span class="w">
        </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Multibase</span><span class="w"> </span><span class="nf">prefix</span><span class="w"> </span><span class="p" data-group-id="1819907503-2">(</span><span class="ss">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">base58btc</span><span class="p" data-group-id="1819907503-2">)</span></code></pre><p><strong>Benefits:</strong></p><ul><li>Self-describing (contains the key itself)</li><li>No resolution needed (unlike did:web or did:eth)</li><li>Compact representation</li><li>Interoperable with UCAN ecosystem</li></ul><hr class="thin"/><h2 id="part-2-creating-capability-tokens-your-application" class="section-heading"><a href="#part-2-creating-capability-tokens-your-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 2: Creating Capability Tokens (Your Application)</span></h2><p>Capability tokens grant specific permissions on specific resources.</p><h3 id="basic-token-creation" class="section-heading"><a href="#basic-token-creation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Token Creation</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION (e.g., auth service)</span><span class="w">
</span><span class="c1">%% Purpose: Issue a token to a client/service</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% Define what permissions to grant</span><span class="w">
</span><span class="n">Grants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3423887361-1">[</span><span class="w">
    </span><span class="c1">%% Can read any stream in the realm</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="3423887361-2">(</span><span class="p" data-group-id="3423887361-3">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/*&quot;</span><span class="p" data-group-id="3423887361-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_READ</span><span class="p" data-group-id="3423887361-2">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Can append to order streams only</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="3423887361-4">(</span><span class="p" data-group-id="3423887361-5">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/orders-*&quot;</span><span class="p" data-group-id="3423887361-5">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_APPEND</span><span class="p" data-group-id="3423887361-4">)</span><span class="w">
</span><span class="p" data-group-id="3423887361-1">]</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Who is this token for? (their DID)</span><span class="w">
</span><span class="n">Audience</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3423887361-6">&lt;&lt;</span><span class="s">&quot;did:key:z6MkClientDID...&quot;</span><span class="p" data-group-id="3423887361-6">&gt;&gt;</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Create the capability (unsigned)</span><span class="w">
</span><span class="n">Cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="3423887361-7">(</span><span class="n">MyIdentity</span><span class="p">,</span><span class="w"> </span><span class="n">Audience</span><span class="p">,</span><span class="w"> </span><span class="n">Grants</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3423887361-8">#{</span><span class="w">
    </span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">900</span><span class="w">  </span><span class="c1">%% 15 minutes - keep it short!</span><span class="w">
</span><span class="p" data-group-id="3423887361-8">}</span><span class="p" data-group-id="3423887361-7">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Sign with YOUR private key (proves you issued it)</span><span class="w">
</span><span class="n">SignedCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">sign</span><span class="p" data-group-id="3423887361-9">(</span><span class="n">Cap</span><span class="p">,</span><span class="w"> </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">private_key</span><span class="p" data-group-id="3423887361-10">(</span><span class="n">MyIdentity</span><span class="p" data-group-id="3423887361-10">)</span><span class="p" data-group-id="3423887361-9">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Encode for transmission</span><span class="w">
</span><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="3423887361-11">(</span><span class="n">SignedCap</span><span class="p">,</span><span class="w"> </span><span class="ss">jwt</span><span class="p" data-group-id="3423887361-11">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; &lt;&lt;&quot;eyJhbGciOiJFZERTQSIsInR5cCI6IlVDQU4ifQ...&quot;&gt;&gt;</span></code></pre><h3 id="understanding-grants" class="section-heading"><a href="#understanding-grants" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Understanding Grants</span></h3><p>A grant specifies WHAT (resource) and HOW (action):</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Grant structure</span><span class="w">
</span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="9651890654-1">(</span><span class="n">Resource</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="p" data-group-id="9651890654-1">)</span><span class="w">

</span><span class="c1">%% Resource: URI pattern for the resource</span><span class="w">
</span><span class="c1">%% Action: What operation is allowed</span></code></pre><h4>Resource URI Patterns</h4><table><thead><tr><th style="text-align: left;">Pattern</th><th style="text-align: left;">Matches</th><th style="text-align: left;">Use Case</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">esdb://realm/stream/orders-123</code></td><td style="text-align: left;">Exact stream</td><td style="text-align: left;">Single aggregate</td></tr><tr><td style="text-align: left;"><code class="inline">esdb://realm/stream/orders-*</code></td><td style="text-align: left;">Prefix match</td><td style="text-align: left;">All order streams</td></tr><tr><td style="text-align: left;"><code class="inline">esdb://realm/stream/*</code></td><td style="text-align: left;">All streams</td><td style="text-align: left;">Admin access</td></tr><tr><td style="text-align: left;"><code class="inline">esdb://realm/channel/events/*</code></td><td style="text-align: left;">All topics</td><td style="text-align: left;">Full channel access</td></tr><tr><td style="text-align: left;"><code class="inline">esdb://realm/channel/events/orders.*</code></td><td style="text-align: left;">Topic prefix</td><td style="text-align: left;">Order events only</td></tr></tbody></table><h4>Available Actions</h4><table><thead><tr><th style="text-align: left;">Constant</th><th style="text-align: left;">Wire Format</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">?ACTION_STREAM_APPEND</code></td><td style="text-align: left;"><code class="inline">stream/append</code></td><td style="text-align: left;">Write events to streams</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_STREAM_READ</code></td><td style="text-align: left;"><code class="inline">stream/read</code></td><td style="text-align: left;">Read events from streams</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_STREAM_SUBSCRIBE</code></td><td style="text-align: left;"><code class="inline">stream/subscribe</code></td><td style="text-align: left;">Subscribe to stream changes</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_CHANNEL_PUBLISH</code></td><td style="text-align: left;"><code class="inline">channel/publish</code></td><td style="text-align: left;">Publish to PubSub channel</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_CHANNEL_SUBSCRIBE</code></td><td style="text-align: left;"><code class="inline">channel/subscribe</code></td><td style="text-align: left;">Subscribe to PubSub topic</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_SNAPSHOT_WRITE</code></td><td style="text-align: left;"><code class="inline">snapshot/write</code></td><td style="text-align: left;">Write snapshots</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_SNAPSHOT_READ</code></td><td style="text-align: left;"><code class="inline">snapshot/read</code></td><td style="text-align: left;">Read snapshots</td></tr><tr><td style="text-align: left;"><code class="inline">?ACTION_ADMIN_ALL</code></td><td style="text-align: left;"><code class="inline">*</code></td><td style="text-align: left;">All actions (use sparingly!)</td></tr></tbody></table><hr class="thin"/><h2 id="part-3-delegation-your-application" class="section-heading"><a href="#part-3-delegation-your-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 3: Delegation (Your Application)</span></h2><p>Delegation allows passing permissions to others <strong>with attenuation</strong> (reducing scope).</p><h3 id="why-delegation-matters" class="section-heading"><a href="#why-delegation-matters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why Delegation Matters</span></h3><p>Consider a microservices architecture where each service delegates to the next with <strong>reduced</strong> permissions:</p><p><img src="assets/delegation_chain.svg" alt="Delegation Chain"/></p><h3 id="delegation-rules" class="section-heading"><a href="#delegation-rules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Delegation Rules</span></h3><ol><li><strong>Attenuation only</strong> - You can reduce permissions, never expand</li><li><strong>TTL inheritance</strong> - Child TTL cannot exceed parent's remaining time</li><li><strong>Proof chain</strong> - Child includes cryptographic reference to parent</li><li><strong>Signature required</strong> - You sign the delegation with YOUR key</li></ol><h3 id="delegation-example" class="section-heading"><a href="#delegation-example" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Delegation Example</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION (Order Service)</span><span class="w">
</span><span class="c1">%% Purpose: Delegate reduced permissions to Payment Service</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% We received Token A with: stream/* read+append</span><span class="w">
</span><span class="c1">%% We want to give Payment Service: orders-*/read only</span><span class="w">

</span><span class="n">WorkerGrants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0508588131-1">[</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="0508588131-2">(</span><span class="p" data-group-id="0508588131-3">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/orders-*&quot;</span><span class="p" data-group-id="0508588131-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_READ</span><span class="p" data-group-id="0508588131-2">)</span><span class="w">
    </span><span class="c1">%% Note: NO append permission - attenuation!</span><span class="w">
</span><span class="p" data-group-id="0508588131-1">]</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Delegate from our token to the worker</span><span class="w">
</span><span class="n">WorkerCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">delegate</span><span class="p" data-group-id="0508588131-4">(</span><span class="w">
    </span><span class="n">OurSignedToken</span><span class="p">,</span><span class="w">        </span><span class="c1">%% Parent token (must be signed)</span><span class="w">
    </span><span class="n">PaymentServiceDID</span><span class="p">,</span><span class="w">     </span><span class="c1">%% Who we&#39;re delegating to</span><span class="w">
    </span><span class="n">WorkerGrants</span><span class="w">           </span><span class="c1">%% Reduced permissions</span><span class="w">
</span><span class="p" data-group-id="0508588131-4">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Sign with OUR key (proves WE delegated it)</span><span class="w">
</span><span class="n">SignedWorkerCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">sign</span><span class="p" data-group-id="0508588131-5">(</span><span class="n">WorkerCap</span><span class="p">,</span><span class="w"> </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">private_key</span><span class="p" data-group-id="0508588131-6">(</span><span class="n">OurIdentity</span><span class="p" data-group-id="0508588131-6">)</span><span class="p" data-group-id="0508588131-5">)</span><span class="p">.</span></code></pre><h3 id="invalid-delegations" class="section-heading"><a href="#invalid-delegations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Invalid Delegations</span></h3><p>These will fail verification on the server:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Parent grants: stream/orders-* with read</span><span class="w">
</span><span class="c1">%% INVALID: trying to add append (not in parent)</span><span class="w">
</span><span class="n">BadGrants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4348636255-1">[</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="4348636255-2">(</span><span class="p" data-group-id="4348636255-3">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/orders-*&quot;</span><span class="p" data-group-id="4348636255-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_APPEND</span><span class="p" data-group-id="4348636255-2">)</span><span class="w">
</span><span class="p" data-group-id="4348636255-1">]</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Parent grants: stream/orders-* with read</span><span class="w">
</span><span class="c1">%% INVALID: trying to access users-* (outside scope)</span><span class="w">
</span><span class="n">BadGrants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4348636255-4">[</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="4348636255-5">(</span><span class="p" data-group-id="4348636255-6">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/users-*&quot;</span><span class="p" data-group-id="4348636255-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_READ</span><span class="p" data-group-id="4348636255-5">)</span><span class="w">
</span><span class="p" data-group-id="4348636255-4">]</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="part-4-using-tokens-your-application-reckon-db" class="section-heading"><a href="#part-4-using-tokens-your-application-reckon-db" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 4: Using Tokens (Your Application → reckon-db)</span></h2><p>When making requests, include the token. The gater routes it to reckon-db for verification.</p><h3 id="stream-operations-with-tokens" class="section-heading"><a href="#stream-operations-with-tokens" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stream Operations with Tokens</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Append events using capability token</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% Include token in request (future API enhancement)</span><span class="w">
</span><span class="c1">%% Currently, tokens are used primarily for PubSub channels</span><span class="w">

</span><span class="n">Events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="4051001707-1">[</span><span class="p" data-group-id="4051001707-2">#{</span><span class="ss">event_type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4051001707-3">&lt;&lt;</span><span class="s">&quot;OrderCreated&quot;</span><span class="p" data-group-id="4051001707-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4051001707-4">#{</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="4051001707-4">}</span><span class="p" data-group-id="4051001707-2">}</span><span class="p" data-group-id="4051001707-1">]</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="4051001707-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="4051001707-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">append_events</span><span class="p" data-group-id="4051001707-6">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4051001707-7">&lt;&lt;</span><span class="s">&quot;orders-123&quot;</span><span class="p" data-group-id="4051001707-7">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Events</span><span class="p" data-group-id="4051001707-6">)</span><span class="p">.</span></code></pre><h3 id="pubsub-channel-operations" class="section-heading"><a href="#pubsub-channel-operations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">PubSub Channel Operations</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Publish/subscribe with capability authorization</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% Create a capability for publishing</span><span class="w">
</span><span class="n">Grants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8806564058-1">[</span><span class="w">
    </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="8806564058-2">(</span><span class="w">
        </span><span class="p" data-group-id="8806564058-3">&lt;&lt;</span><span class="s">&quot;esdb://myapp/channel/esdb_channel_events/*&quot;</span><span class="p" data-group-id="8806564058-3">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="o">?</span><span class="n">ACTION_CHANNEL_PUBLISH</span><span class="w">
    </span><span class="p" data-group-id="8806564058-2">)</span><span class="w">
</span><span class="p" data-group-id="8806564058-1">]</span><span class="p">,</span><span class="w">
</span><span class="n">Cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="8806564058-4">(</span><span class="n">Issuer</span><span class="p">,</span><span class="w"> </span><span class="n">Audience</span><span class="p">,</span><span class="w"> </span><span class="n">Grants</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8806564058-5">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">900</span><span class="p" data-group-id="8806564058-5">}</span><span class="p" data-group-id="8806564058-4">)</span><span class="p">,</span><span class="w">
</span><span class="n">SignedCap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">sign</span><span class="p" data-group-id="8806564058-6">(</span><span class="n">Cap</span><span class="p">,</span><span class="w"> </span><span class="nc">esdb_identity</span><span class="p">:</span><span class="nf">private_key</span><span class="p" data-group-id="8806564058-7">(</span><span class="n">Issuer</span><span class="p" data-group-id="8806564058-7">)</span><span class="p" data-group-id="8806564058-6">)</span><span class="p">,</span><span class="w">
</span><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="8806564058-8">(</span><span class="n">SignedCap</span><span class="p">,</span><span class="w"> </span><span class="ss">binary</span><span class="p" data-group-id="8806564058-8">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Publish with capability token</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_channel</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8806564058-9">(</span><span class="ss">esdb_channel_events</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8806564058-10">&lt;&lt;</span><span class="s">&quot;orders.created&quot;</span><span class="p" data-group-id="8806564058-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="p" data-group-id="8806564058-9">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Subscribe with capability token</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_channel</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="8806564058-11">(</span><span class="ss">esdb_channel_events</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8806564058-12">&lt;&lt;</span><span class="s">&quot;orders.*&quot;</span><span class="p" data-group-id="8806564058-12">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="8806564058-13">(</span><span class="p" data-group-id="8806564058-13">)</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="p" data-group-id="8806564058-11">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="part-5-token-verification-reckon-db-server" class="section-heading"><a href="#part-5-token-verification-reckon-db-server" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 5: Token Verification (reckon-db Server)</span></h2><p><strong>You don't write this code</strong> - it runs automatically on the reckon-db server.</p><h3 id="what-the-server-checks" class="section-heading"><a href="#what-the-server-checks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What the Server Checks</span></h3><ol><li><strong>Signature valid?</strong> - Cryptographically verify using issuer's public key</li><li><strong>Not expired?</strong> - Check <code class="inline">exp</code> timestamp against current time</li><li><strong>Not before valid?</strong> - Check <code class="inline">nbf</code> timestamp</li><li><strong>Not revoked?</strong> - Check against revocation list</li><li><strong>Resource matches?</strong> - Does the grant cover the requested resource?</li><li><strong>Action allowed?</strong> - Does the grant include the requested action?</li><li><strong>Delegation valid?</strong> - If delegated, verify parent chain</li></ol><h3 id="verification-flow" class="section-heading"><a href="#verification-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Verification Flow</span></h3><p><img src="assets/verification_flow.svg" alt="Token Verification Flow"/></p><hr class="thin"/><h2 id="part-6-token-formats" class="section-heading"><a href="#part-6-token-formats" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Part 6: Token Formats</span></h2><h3 id="jwt-format-interoperable" class="section-heading"><a href="#jwt-format-interoperable" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">JWT Format (Interoperable)</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="1497944622-1">(</span><span class="n">Cap</span><span class="p">,</span><span class="w"> </span><span class="ss">jwt</span><span class="p" data-group-id="1497944622-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; &lt;&lt;&quot;eyJhbGciOiJFZERTQSIsInR5cCI6IlVDQU4ifQ.eyJpc3MiOiJkaWQ6...&quot;&gt;&gt;</span></code></pre><p><strong>Use when:</strong></p><ul><li>Communicating with web clients (JavaScript)</li><li>Crossing system boundaries</li><li>Debugging (JWTs are human-readable when decoded)</li><li>Interoperating with other UCAN-compatible systems</li></ul><h3 id="erlang-binary-format-fast" class="section-heading"><a href="#erlang-binary-format-fast" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Erlang Binary Format (Fast)</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="3741040443-1">(</span><span class="n">Cap</span><span class="p">,</span><span class="w"> </span><span class="ss">binary</span><span class="p" data-group-id="3741040443-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; &lt;&lt;131, 104, 12, 100, ...&gt;&gt;</span></code></pre><p><strong>Use when:</strong></p><ul><li>Internal mesh communication</li><li>Maximum performance is critical</li><li>Both ends are Erlang/Elixir</li></ul><p>Decoding auto-detects format:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="6228019646-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Cap</span><span class="p" data-group-id="6228019646-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">decode</span><span class="p" data-group-id="6228019646-2">(</span><span class="n">Token</span><span class="p" data-group-id="6228019646-2">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% Works for both formats</span></code></pre><hr class="thin"/><h2 id="common-pitfalls" class="section-heading"><a href="#common-pitfalls" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Pitfalls</span></h2><h3 id="1-token-lifetime-too-long" class="section-heading"><a href="#1-token-lifetime-too-long" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Token Lifetime Too Long</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Token valid for 30 days</span><span class="w">
</span><span class="n">Cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="8837991588-1">(</span><span class="n">Iss</span><span class="p">,</span><span class="w"> </span><span class="n">Aud</span><span class="p">,</span><span class="w"> </span><span class="n">Grants</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8837991588-2">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p" data-group-id="8837991588-2">}</span><span class="p" data-group-id="8837991588-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Short-lived tokens, refresh as needed</span><span class="w">
</span><span class="n">Cap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="8837991588-3">(</span><span class="n">Iss</span><span class="p">,</span><span class="w"> </span><span class="n">Aud</span><span class="p">,</span><span class="w"> </span><span class="n">Grants</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8837991588-4">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">900</span><span class="p" data-group-id="8837991588-4">}</span><span class="p" data-group-id="8837991588-3">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% 15 minutes</span></code></pre><p><strong>Why:</strong> If a token is compromised, damage is limited to its lifetime.</p><h3 id="2-overly-broad-grants" class="section-heading"><a href="#2-overly-broad-grants" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Overly Broad Grants</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Admin access for everything</span><span class="w">
</span><span class="n">Grants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7592037622-1">[</span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="7592037622-2">(</span><span class="p" data-group-id="7592037622-3">&lt;&lt;</span><span class="s">&quot;esdb://myapp/*&quot;</span><span class="p" data-group-id="7592037622-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_ADMIN_ALL</span><span class="p" data-group-id="7592037622-2">)</span><span class="p" data-group-id="7592037622-1">]</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Minimum necessary permissions</span><span class="w">
</span><span class="n">Grants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7592037622-4">[</span><span class="nc">esdb_capability</span><span class="p">:</span><span class="nf">grant</span><span class="p" data-group-id="7592037622-5">(</span><span class="p" data-group-id="7592037622-6">&lt;&lt;</span><span class="s">&quot;esdb://myapp/stream/orders-*&quot;</span><span class="p" data-group-id="7592037622-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ACTION_STREAM_READ</span><span class="p" data-group-id="7592037622-5">)</span><span class="p" data-group-id="7592037622-4">]</span><span class="p">.</span></code></pre><p><strong>Why:</strong> Principle of least privilege limits blast radius.</p><h3 id="3-storing-private-keys-in-code" class="section-heading"><a href="#3-storing-private-keys-in-code" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Storing Private Keys in Code</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Hardcoded private key</span><span class="w">
</span><span class="n">PrivKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3167846501-1">&lt;&lt;</span><span class="mi">16#deadbeef</span><span class="p">:</span><span class="mi">256</span><span class="p" data-group-id="3167846501-1">&gt;&gt;</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Load from secure storage at runtime</span><span class="w">
</span><span class="p" data-group-id="3167846501-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">PrivKey</span><span class="p" data-group-id="3167846501-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">secrets_manager</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="3167846501-3">(</span><span class="p" data-group-id="3167846501-4">&lt;&lt;</span><span class="s">&quot;my-service-private-key&quot;</span><span class="p" data-group-id="3167846501-4">&gt;&gt;</span><span class="p" data-group-id="3167846501-3">)</span><span class="p">.</span></code></pre><h3 id="4-ignoring-token-validation-errors" class="section-heading"><a href="#4-ignoring-token-validation-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Ignoring Token Validation Errors</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Ignoring errors</span><span class="w">
</span><span class="nc">esdb_channel</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="3033971572-1">(</span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="p" data-group-id="3033971572-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Handle authorization failures</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">esdb_channel</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="3033971572-2">(</span><span class="n">Channel</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">Token</span><span class="p" data-group-id="3033971572-2">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="3033971572-3">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3033971572-4">{</span><span class="ss">unauthorized</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="3033971572-4">}</span><span class="p" data-group-id="3033971572-3">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">logger</span><span class="p">:</span><span class="nf">warning</span><span class="p" data-group-id="3033971572-5">(</span><span class="s">&quot;Publish denied: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3033971572-6">[</span><span class="n">Reason</span><span class="p" data-group-id="3033971572-6">]</span><span class="p" data-group-id="3033971572-5">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="3033971572-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">forbidden</span><span class="p" data-group-id="3033971572-7">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="security-considerations" class="section-heading"><a href="#security-considerations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Security Considerations</span></h2><h3 id="short-token-lifetimes" class="section-heading"><a href="#short-token-lifetimes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Short Token Lifetimes</span></h3><p>Default TTL is 15 minutes. This is intentional:</p><ul><li>Limits exposure if token is leaked</li><li>Forces regular re-authentication</li><li>Revocation becomes less critical (tokens expire quickly)</li></ul><h3 id="key-rotation" class="section-heading"><a href="#key-rotation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Rotation</span></h3><p>Rotate identity keys periodically:</p><ol><li>Generate new keypair</li><li>Start issuing tokens with new key</li><li>Keep old key for verification until old tokens expire</li><li>Retire old key</li></ol><h3 id="revocation-strategy" class="section-heading"><a href="#revocation-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Revocation Strategy</span></h3><p>For LAN clusters (typical reckon-db deployment), short TTLs are usually sufficient. Emergency revocation is available via <code class="inline">esdb_revocation</code> in reckon-db:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Server-side (reckon-db) - emergency revocation</span><span class="w">
</span><span class="nc">esdb_revocation</span><span class="p">:</span><span class="nf">revoke</span><span class="p" data-group-id="1093727584-1">(</span><span class="n">TokenCID</span><span class="p" data-group-id="1093727584-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="api-reference" class="section-heading"><a href="#api-reference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">API Reference</span></h2><h3 id="esdb_identity-your-application" class="section-heading"><a href="#esdb_identity-your-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">esdb_identity (Your Application)</span></h3><table><thead><tr><th style="text-align: left;">Function</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">generate()</code></td><td style="text-align: left;">Generate new Ed25519 identity</td></tr><tr><td style="text-align: left;"><code class="inline">from_keypair(Pub, Priv)</code></td><td style="text-align: left;">Create from existing keys</td></tr><tr><td style="text-align: left;"><code class="inline">from_public_key(Pub)</code></td><td style="text-align: left;">Create from public key only (for verification)</td></tr><tr><td style="text-align: left;"><code class="inline">did(Identity)</code></td><td style="text-align: left;">Get DID string</td></tr><tr><td style="text-align: left;"><code class="inline">public_key(Identity)</code></td><td style="text-align: left;">Get 32-byte public key</td></tr><tr><td style="text-align: left;"><code class="inline">private_key(Identity)</code></td><td style="text-align: left;">Get 32-byte private key</td></tr><tr><td style="text-align: left;"><code class="inline">public_key_from_did(DID)</code></td><td style="text-align: left;">Extract public key from DID</td></tr></tbody></table><h3 id="esdb_capability-your-application" class="section-heading"><a href="#esdb_capability-your-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">esdb_capability (Your Application)</span></h3><table><thead><tr><th style="text-align: left;">Function</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">create(Iss, Aud, Grants)</code></td><td style="text-align: left;">Create unsigned capability</td></tr><tr><td style="text-align: left;"><code class="inline">create(Iss, Aud, Grants, Opts)</code></td><td style="text-align: left;">Create with options (ttl, nbf)</td></tr><tr><td style="text-align: left;"><code class="inline">sign(Cap, PrivKey)</code></td><td style="text-align: left;">Sign with Ed25519 private key</td></tr><tr><td style="text-align: left;"><code class="inline">delegate(Parent, Aud, Grants)</code></td><td style="text-align: left;">Delegate with attenuation</td></tr><tr><td style="text-align: left;"><code class="inline">encode(Cap, jwt | binary)</code></td><td style="text-align: left;">Encode for transmission</td></tr><tr><td style="text-align: left;"><code class="inline">decode(Token)</code></td><td style="text-align: left;">Decode from any format</td></tr><tr><td style="text-align: left;"><code class="inline">grant(Resource, Action)</code></td><td style="text-align: left;">Create a grant tuple</td></tr><tr><td style="text-align: left;"><code class="inline">is_expired(Cap)</code></td><td style="text-align: left;">Check if token has expired</td></tr></tbody></table><h3 id="esdb_capability_verifier-reckon-db-server" class="section-heading"><a href="#esdb_capability_verifier-reckon-db-server" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">esdb_capability_verifier (reckon-db Server)</span></h3><table><thead><tr><th style="text-align: left;">Function</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">verify(Token)</code></td><td style="text-align: left;">Verify signature and time bounds</td></tr><tr><td style="text-align: left;"><code class="inline">authorize(Token, Resource, Action)</code></td><td style="text-align: left;">Full authorization check</td></tr></tbody></table><hr class="thin"/><h2 id="further-reading" class="section-heading"><a href="#further-reading" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Further Reading</span></h2><ul><li><a href="https://github.com/ucan-wg/spec">UCAN Specification</a> - The standard we follow</li><li><a href="https://w3c-ccg.github.io/did-method-key/">DID Key Method</a> - How DIDs encode keys</li><li><a href="https://ed25519.cr.yp.to/">Ed25519 Signatures</a> - The cryptography behind it</li><li><a href="https://en.wikipedia.org/wiki/Capability-based_security">Capability-Based Security (Wikipedia)</a> - Conceptual background</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="shared_types.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Shared Types
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="temporal_queries.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Temporal Queries
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/reckon_gater/1.1.2" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/reckon_gater/1.1.2">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/reckon_gater/1.1.2/show/guides/capability_security.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="reckon_gater.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
