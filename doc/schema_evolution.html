<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="reckon_gater v1.0.0">


    <title>Schema Evolution — reckon_gater v1.0.0</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-CB9EB389.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
reckon_gater
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v1.0.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of reckon_gater</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Schema Evolution</h1>


      <a href="https://github.com/reckon-db-org/reckon-gater/blob/v1.0.0/guides/schema_evolution.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide explains how to evolve event schemas over time while maintaining backward compatibility. Old events are automatically &quot;upcasted&quot; to the current schema version when read.</p><p><img src="assets/schema_upcasting.svg" alt="Schema Upcasting"/></p><h2 id="prerequisites" class="section-heading"><a href="#prerequisites" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Prerequisites</span></h2><p>Before reading this guide, you should understand:</p><ul><li>Event sourcing concepts (<a href="event_sourcing.html">Event Sourcing Guide</a>)</li><li>The immutable nature of events (events are never modified after being written)</li><li>Why backward compatibility matters in event-driven systems</li></ul><h2 id="the-problem-business-requirements-change" class="section-heading"><a href="#the-problem-business-requirements-change" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Problem: Business Requirements Change</span></h2><p>In event sourcing, events are immutable facts. But business requirements evolve:</p><ul><li>New fields are added (<code class="inline">phone</code> added to <code class="inline">UserCreated</code>)</li><li>Field names are renamed (<code class="inline">amount_cents</code> → <code class="inline">amount</code>)</li><li>Data formats change (cents as integer → dollars as decimal)</li><li>Fields are split (<code class="inline">full_name</code> → <code class="inline">first_name</code> + <code class="inline">last_name</code>)</li></ul><p><strong>You cannot migrate events</strong> - they're immutable historical records. Changing them would break the audit trail.</p><h2 id="the-solution-schema-registry-upcasting" class="section-heading"><a href="#the-solution-schema-registry-upcasting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">The Solution: Schema Registry + Upcasting</span></h2><p>Instead of migrating events, we transform them <strong>on read</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Write</span><span class="w"> </span><span class="p" data-group-id="6730334162-1">(</span><span class="ss">immutable</span><span class="p" data-group-id="6730334162-1">)</span><span class="p">:</span><span class="w">           </span><span class="n">Read</span><span class="w"> </span><span class="p" data-group-id="6730334162-2">(</span><span class="ss">transformed</span><span class="p" data-group-id="6730334162-2">)</span><span class="p">:</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">         </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">UserCreated</span><span class="w"> </span><span class="ss">v1</span><span class="w">   </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w"> </span><span class="n">UserCreated</span><span class="w"> </span><span class="ss">v3</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6730334162-3">{</span><span class="w">                </span><span class="err">│</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">→</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6730334162-4">{</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="nc">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="ss">upcast</span><span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="nc">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="nc">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="w">   </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">   </span><span class="nc">email</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="p">,</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6730334162-4">}</span><span class="w">                </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">   </span><span class="nc">phone</span><span class="p">:</span><span class="w"> </span><span class="ss">null</span><span class="p">,</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">         </span><span class="err">│</span><span class="w">   </span><span class="nc">verified</span><span class="p">:</span><span class="w"> </span><span class="ss">false</span><span class="err">│</span><span class="w">
                             </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="6730334162-3">}</span><span class="w">                </span><span class="err">│</span><span class="w">
                             </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p><strong>Key insight:</strong> Events stay as written. Transformation happens at read time. Consumers always see the current schema.</p><hr class="thin"/><h2 id="where-does-this-code-run" class="section-heading"><a href="#where-does-this-code-run" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Where Does This Code Run?</span></h2><table><thead><tr><th style="text-align: left;">Operation</th><th style="text-align: left;">Location</th><th style="text-align: left;">Module</th></tr></thead><tbody><tr><td style="text-align: left;">Register schema</td><td style="text-align: left;">Your Application</td><td style="text-align: left;"><code class="inline">esdb_gater_api</code></td></tr><tr><td style="text-align: left;">Define upcast functions</td><td style="text-align: left;">Your Application</td><td style="text-align: left;">Your schema module</td></tr><tr><td style="text-align: left;">Store schema definitions</td><td style="text-align: left;">reckon-db Server</td><td style="text-align: left;"><code class="inline">reckon_db_schema_store</code></td></tr><tr><td style="text-align: left;">Apply upcasting on read</td><td style="text-align: left;">reckon-db Server</td><td style="text-align: left;"><code class="inline">reckon_db_upcaster</code></td></tr></tbody></table><hr class="thin"/><h2 id="api-reference" class="section-heading"><a href="#api-reference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">API Reference</span></h2><h3 id="register-a-schema" class="section-heading"><a href="#register-a-schema" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Register a Schema</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Register initial schema version for an event type</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">register_schema</span><span class="p" data-group-id="4569360936-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4569360936-2">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="4569360936-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4569360936-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">fields</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4569360936-4">[</span><span class="w">
        </span><span class="p" data-group-id="4569360936-5">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4569360936-6">&lt;&lt;</span><span class="s">&quot;name&quot;</span><span class="p" data-group-id="4569360936-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p">,</span><span class="w"> </span><span class="ss">required</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="4569360936-5">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4569360936-7">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4569360936-8">&lt;&lt;</span><span class="s">&quot;email&quot;</span><span class="p" data-group-id="4569360936-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p">,</span><span class="w"> </span><span class="ss">required</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="4569360936-7">}</span><span class="w">
    </span><span class="p" data-group-id="4569360936-4">]</span><span class="w">
</span><span class="p" data-group-id="4569360936-3">}</span><span class="p" data-group-id="4569360936-1">)</span><span class="p">.</span></code></pre><h3 id="register-new-version-with-upcast" class="section-heading"><a href="#register-new-version-with-upcast" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Register New Version with Upcast</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Add new schema version with transformation from v1</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">register_schema</span><span class="p" data-group-id="8159323446-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8159323446-2">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="8159323446-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8159323446-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="ss">fields</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8159323446-4">[</span><span class="w">
        </span><span class="p" data-group-id="8159323446-5">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8159323446-6">&lt;&lt;</span><span class="s">&quot;name&quot;</span><span class="p" data-group-id="8159323446-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p">,</span><span class="w"> </span><span class="ss">required</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="8159323446-5">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="8159323446-7">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8159323446-8">&lt;&lt;</span><span class="s">&quot;email&quot;</span><span class="p" data-group-id="8159323446-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p">,</span><span class="w"> </span><span class="ss">required</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="8159323446-7">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="8159323446-9">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8159323446-10">&lt;&lt;</span><span class="s">&quot;phone&quot;</span><span class="p" data-group-id="8159323446-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p">,</span><span class="w"> </span><span class="ss">required</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="8159323446-9">}</span><span class="w">  </span><span class="c1">%% New field</span><span class="w">
    </span><span class="p" data-group-id="8159323446-4">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8159323446-11">#{</span><span class="w">
        </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="8159323446-12">(</span><span class="n">V1Data</span><span class="p" data-group-id="8159323446-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Transform v1 → v2: add missing phone field</span><span class="w">
            </span><span class="n">V1Data</span><span class="p" data-group-id="8159323446-13">#{</span><span class="p" data-group-id="8159323446-14">&lt;&lt;</span><span class="s">&quot;phone&quot;</span><span class="p" data-group-id="8159323446-14">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="8159323446-13">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="p" data-group-id="8159323446-11">}</span><span class="w">
</span><span class="p" data-group-id="8159323446-3">}</span><span class="p" data-group-id="8159323446-1">)</span><span class="p">.</span></code></pre><h3 id="get-schema-information" class="section-heading"><a href="#get-schema-information" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Get Schema Information</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Query registered schemas</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% Get current schema for an event type</span><span class="w">
</span><span class="p" data-group-id="2489790919-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p" data-group-id="2489790919-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">get_schema</span><span class="p" data-group-id="2489790919-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2489790919-3">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="2489790919-3">&gt;&gt;</span><span class="p" data-group-id="2489790919-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get current version number</span><span class="w">
</span><span class="p" data-group-id="2489790919-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="2489790919-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">get_schema_version</span><span class="p" data-group-id="2489790919-5">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2489790919-6">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="2489790919-6">&gt;&gt;</span><span class="p" data-group-id="2489790919-5">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; {ok, 2}</span><span class="w">

</span><span class="c1">%% List all registered schemas</span><span class="w">
</span><span class="p" data-group-id="2489790919-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Schemas</span><span class="p" data-group-id="2489790919-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">list_schemas</span><span class="p" data-group-id="2489790919-8">(</span><span class="ss">my_store</span><span class="p" data-group-id="2489790919-8">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% =&gt; [</span><span class="w">
</span><span class="c1">%%     #{event_type =&gt; &lt;&lt;&quot;UserCreated&quot;&gt;&gt;, version =&gt; 2},</span><span class="w">
</span><span class="c1">%%     #{event_type =&gt; &lt;&lt;&quot;OrderPlaced&quot;&gt;&gt;, version =&gt; 3},</span><span class="w">
</span><span class="c1">%%     ...</span><span class="w">
</span><span class="c1">%% ]</span></code></pre><h3 id="upcast-events-explicitly" class="section-heading"><a href="#upcast-events-explicitly" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upcast Events Explicitly</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Manually upcast events to current schema version</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="c1">%% Read old events</span><span class="w">
</span><span class="p" data-group-id="7635506112-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">OldEvents</span><span class="p" data-group-id="7635506112-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">stream_forward</span><span class="p" data-group-id="7635506112-2">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="7635506112-2">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Upcast to current schema versions</span><span class="w">
</span><span class="p" data-group-id="7635506112-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">UpcastedEvents</span><span class="p" data-group-id="7635506112-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">upcast_events</span><span class="p" data-group-id="7635506112-4">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">OldEvents</span><span class="p" data-group-id="7635506112-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Events are now in current schema version</span></code></pre><h3 id="unregister-schema" class="section-heading"><a href="#unregister-schema" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Unregister Schema</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Remove a deprecated event type&#39;s schema</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">unregister_schema</span><span class="p" data-group-id="6245627473-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6245627473-2">&lt;&lt;</span><span class="s">&quot;DeprecatedEvent&quot;</span><span class="p" data-group-id="6245627473-2">&gt;&gt;</span><span class="p" data-group-id="6245627473-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="upcast-chain" class="section-heading"><a href="#upcast-chain" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upcast Chain</span></h2><p>When multiple schema versions exist, upcasting chains automatically:</p><pre><code class="makeup erlang" translate="no"><span class="ss">v1</span><span class="w"> </span><span class="ss">event</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nf">upcast_v1_v2</span><span class="p" data-group-id="9196877527-1">(</span><span class="p" data-group-id="9196877527-1">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">v2</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nf">upcast_v2_v3</span><span class="p" data-group-id="9196877527-2">(</span><span class="p" data-group-id="9196877527-2">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">v3</span><span class="w"> </span><span class="nf">data</span><span class="w"> </span><span class="p" data-group-id="9196877527-3">(</span><span class="ss">current</span><span class="p" data-group-id="9196877527-3">)</span></code></pre><p>Example with 3 versions:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Register schema with full upcast chain</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">register_schema</span><span class="p" data-group-id="1124256744-1">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1124256744-2">&lt;&lt;</span><span class="s">&quot;OrderPlaced&quot;</span><span class="p" data-group-id="1124256744-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1124256744-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">fields</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-4">[</span><span class="w">
        </span><span class="p" data-group-id="1124256744-5">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-6">&lt;&lt;</span><span class="s">&quot;order_id&quot;</span><span class="p" data-group-id="1124256744-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p" data-group-id="1124256744-5">}</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="1124256744-7">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-8">&lt;&lt;</span><span class="s">&quot;amount&quot;</span><span class="p" data-group-id="1124256744-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">decimal</span><span class="p" data-group-id="1124256744-7">}</span><span class="p">,</span><span class="w">       </span><span class="c1">%% Changed from cents in v1</span><span class="w">
        </span><span class="p" data-group-id="1124256744-9">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-10">&lt;&lt;</span><span class="s">&quot;currency&quot;</span><span class="p" data-group-id="1124256744-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p" data-group-id="1124256744-9">}</span><span class="p">,</span><span class="w">      </span><span class="c1">%% Added in v2</span><span class="w">
        </span><span class="p" data-group-id="1124256744-11">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-12">&lt;&lt;</span><span class="s">&quot;customer_id&quot;</span><span class="p" data-group-id="1124256744-12">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">string</span><span class="p" data-group-id="1124256744-11">}</span><span class="w">    </span><span class="c1">%% Added in v3</span><span class="w">
    </span><span class="p" data-group-id="1124256744-4">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-13">#{</span><span class="w">
        </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="1124256744-14">(</span><span class="n">V1</span><span class="p" data-group-id="1124256744-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% v1 had amount_cents (integer), no currency</span><span class="w">
            </span><span class="p" data-group-id="1124256744-15">#{</span><span class="w">
                </span><span class="p" data-group-id="1124256744-16">&lt;&lt;</span><span class="s">&quot;order_id&quot;</span><span class="p" data-group-id="1124256744-16">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1124256744-17">(</span><span class="p" data-group-id="1124256744-18">&lt;&lt;</span><span class="s">&quot;order_id&quot;</span><span class="p" data-group-id="1124256744-18">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="1124256744-17">)</span><span class="p">,</span><span class="w">
                </span><span class="p" data-group-id="1124256744-19">&lt;&lt;</span><span class="s">&quot;amount&quot;</span><span class="p" data-group-id="1124256744-19">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1124256744-20">(</span><span class="p" data-group-id="1124256744-21">&lt;&lt;</span><span class="s">&quot;amount_cents&quot;</span><span class="p" data-group-id="1124256744-21">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="1124256744-20">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
                </span><span class="p" data-group-id="1124256744-22">&lt;&lt;</span><span class="s">&quot;currency&quot;</span><span class="p" data-group-id="1124256744-22">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1124256744-23">&lt;&lt;</span><span class="s">&quot;USD&quot;</span><span class="p" data-group-id="1124256744-23">&gt;&gt;</span><span class="p">,</span><span class="w">  </span><span class="c1">%% Default for old events</span><span class="w">
                </span><span class="p" data-group-id="1124256744-24">&lt;&lt;</span><span class="s">&quot;customer_id&quot;</span><span class="p" data-group-id="1124256744-24">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">undefined</span><span class="w">
            </span><span class="p" data-group-id="1124256744-15">}</span><span class="w">
        </span><span class="k">end</span><span class="p">,</span><span class="w">
        </span><span class="mi">2</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="1124256744-25">(</span><span class="n">V2</span><span class="p" data-group-id="1124256744-25">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% v2 had amount + currency, no customer</span><span class="w">
            </span><span class="n">V2</span><span class="p" data-group-id="1124256744-26">#{</span><span class="p" data-group-id="1124256744-27">&lt;&lt;</span><span class="s">&quot;customer_id&quot;</span><span class="p" data-group-id="1124256744-27">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="1124256744-26">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="p" data-group-id="1124256744-13">}</span><span class="w">
</span><span class="p" data-group-id="1124256744-3">}</span><span class="p" data-group-id="1124256744-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="common-transformation-patterns" class="section-heading"><a href="#common-transformation-patterns" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Transformation Patterns</span></h2><h3 id="adding-fields-most-common" class="section-heading"><a href="#adding-fields-most-common" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Adding Fields (Most Common)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Add new field with default value</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3716962892-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3716962892-2">(</span><span class="n">V1</span><span class="p" data-group-id="3716962892-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">V1</span><span class="p" data-group-id="3716962892-3">#{</span><span class="p" data-group-id="3716962892-4">&lt;&lt;</span><span class="s">&quot;new_field&quot;</span><span class="p" data-group-id="3716962892-4">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">default_value</span><span class="p" data-group-id="3716962892-3">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="3716962892-1">}</span></code></pre><h3 id="renaming-fields" class="section-heading"><a href="#renaming-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Renaming Fields</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Rename a field while preserving data</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9710430471-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9710430471-2">(</span><span class="n">V1</span><span class="p" data-group-id="9710430471-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">OldValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9710430471-3">(</span><span class="p" data-group-id="9710430471-4">&lt;&lt;</span><span class="s">&quot;old_name&quot;</span><span class="p" data-group-id="9710430471-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="9710430471-3">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="9710430471-5">(</span><span class="p" data-group-id="9710430471-6">&lt;&lt;</span><span class="s">&quot;old_name&quot;</span><span class="p" data-group-id="9710430471-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="9710430471-7">#{</span><span class="p" data-group-id="9710430471-8">&lt;&lt;</span><span class="s">&quot;new_name&quot;</span><span class="p" data-group-id="9710430471-8">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">OldValue</span><span class="p" data-group-id="9710430471-7">}</span><span class="p" data-group-id="9710430471-5">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="9710430471-1">}</span></code></pre><h3 id="changing-data-types" class="section-heading"><a href="#changing-data-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Changing Data Types</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Convert data format (cents → dollars)</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6776186350-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6776186350-2">(</span><span class="n">V1</span><span class="p" data-group-id="6776186350-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Convert cents (integer) to dollars (decimal)</span><span class="w">
        </span><span class="n">Cents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6776186350-3">(</span><span class="p" data-group-id="6776186350-4">&lt;&lt;</span><span class="s">&quot;amount_cents&quot;</span><span class="p" data-group-id="6776186350-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="6776186350-3">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="6776186350-5">(</span><span class="p" data-group-id="6776186350-6">&lt;&lt;</span><span class="s">&quot;amount_cents&quot;</span><span class="p" data-group-id="6776186350-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="6776186350-7">#{</span><span class="p" data-group-id="6776186350-8">&lt;&lt;</span><span class="s">&quot;amount&quot;</span><span class="p" data-group-id="6776186350-8">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cents</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="6776186350-7">}</span><span class="p" data-group-id="6776186350-5">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="6776186350-1">}</span></code></pre><h3 id="splitting-fields" class="section-heading"><a href="#splitting-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Splitting Fields</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Split one field into multiple fields</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6180075040-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6180075040-2">(</span><span class="n">V1</span><span class="p" data-group-id="6180075040-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Split &quot;full_name&quot; into &quot;first_name&quot; and &quot;last_name&quot;</span><span class="w">
        </span><span class="n">FullName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6180075040-3">(</span><span class="p" data-group-id="6180075040-4">&lt;&lt;</span><span class="s">&quot;full_name&quot;</span><span class="p" data-group-id="6180075040-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="6180075040-3">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="6180075040-5">[</span><span class="n">First</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="6180075040-5">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">binary</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="6180075040-6">(</span><span class="n">FullName</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6180075040-7">&lt;&lt;</span><span class="s">&quot; &quot;</span><span class="p" data-group-id="6180075040-7">&gt;&gt;</span><span class="p" data-group-id="6180075040-6">)</span><span class="p">,</span><span class="w">
        </span><span class="n">Last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">iolist_to_binary</span><span class="p" data-group-id="6180075040-8">(</span><span class="nc">lists</span><span class="p">:</span><span class="nf">join</span><span class="p" data-group-id="6180075040-9">(</span><span class="p" data-group-id="6180075040-10">&lt;&lt;</span><span class="s">&quot; &quot;</span><span class="p" data-group-id="6180075040-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="6180075040-9">)</span><span class="p" data-group-id="6180075040-8">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="6180075040-11">(</span><span class="p" data-group-id="6180075040-12">&lt;&lt;</span><span class="s">&quot;full_name&quot;</span><span class="p" data-group-id="6180075040-12">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="6180075040-13">#{</span><span class="w">
            </span><span class="p" data-group-id="6180075040-14">&lt;&lt;</span><span class="s">&quot;first_name&quot;</span><span class="p" data-group-id="6180075040-14">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">First</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="6180075040-15">&lt;&lt;</span><span class="s">&quot;last_name&quot;</span><span class="p" data-group-id="6180075040-15">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Last</span><span class="w">
        </span><span class="p" data-group-id="6180075040-13">}</span><span class="p" data-group-id="6180075040-11">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="6180075040-1">}</span></code></pre><h3 id="merging-fields" class="section-heading"><a href="#merging-fields" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Merging Fields</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Combine multiple fields into one</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9129376226-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9129376226-2">(</span><span class="n">V1</span><span class="p" data-group-id="9129376226-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">Street</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9129376226-3">(</span><span class="p" data-group-id="9129376226-4">&lt;&lt;</span><span class="s">&quot;street&quot;</span><span class="p" data-group-id="9129376226-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="9129376226-3">)</span><span class="p">,</span><span class="w">
        </span><span class="n">City</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9129376226-5">(</span><span class="p" data-group-id="9129376226-6">&lt;&lt;</span><span class="s">&quot;city&quot;</span><span class="p" data-group-id="9129376226-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="9129376226-5">)</span><span class="p">,</span><span class="w">
        </span><span class="n">Combined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9129376226-7">&lt;&lt;</span><span class="n">Street</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">City</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="9129376226-7">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">without</span><span class="p" data-group-id="9129376226-8">(</span><span class="p" data-group-id="9129376226-9">[</span><span class="p" data-group-id="9129376226-10">&lt;&lt;</span><span class="s">&quot;street&quot;</span><span class="p" data-group-id="9129376226-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9129376226-11">&lt;&lt;</span><span class="s">&quot;city&quot;</span><span class="p" data-group-id="9129376226-11">&gt;&gt;</span><span class="p" data-group-id="9129376226-9">]</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="9129376226-12">#{</span><span class="p" data-group-id="9129376226-13">&lt;&lt;</span><span class="s">&quot;address&quot;</span><span class="p" data-group-id="9129376226-13">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Combined</span><span class="p" data-group-id="9129376226-12">}</span><span class="p" data-group-id="9129376226-8">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="9129376226-1">}</span></code></pre><hr class="thin"/><h2 id="common-pitfalls" class="section-heading"><a href="#common-pitfalls" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Pitfalls</span></h2><h3 id="1-modifying-existing-schema-version" class="section-heading"><a href="#1-modifying-existing-schema-version" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Modifying Existing Schema Version</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Changing v1 schema after events are written</span><span class="w">
</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">register_schema</span><span class="p" data-group-id="6626368479-1">(</span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6626368479-2">&lt;&lt;</span><span class="s">&quot;Event&quot;</span><span class="p" data-group-id="6626368479-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6626368479-3">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">fields</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6626368479-4">[</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="ss">different</span><span class="w"> </span><span class="ss">fields</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="6626368479-4">]</span><span class="w">  </span><span class="c1">%% Breaks existing v1 events!</span><span class="w">
</span><span class="p" data-group-id="6626368479-3">}</span><span class="p" data-group-id="6626368479-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Create new version instead</span><span class="w">
</span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">register_schema</span><span class="p" data-group-id="6626368479-5">(</span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6626368479-6">&lt;&lt;</span><span class="s">&quot;Event&quot;</span><span class="p" data-group-id="6626368479-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6626368479-7">#{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="ss">fields</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6626368479-8">[</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="ss">new</span><span class="w"> </span><span class="ss">fields</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="6626368479-8">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="6626368479-9">#{</span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6626368479-10">(</span><span class="n">V1</span><span class="p" data-group-id="6626368479-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="6626368479-9">}</span><span class="w">
</span><span class="p" data-group-id="6626368479-7">}</span><span class="p" data-group-id="6626368479-5">)</span><span class="p">.</span></code></pre><h3 id="2-upcast-functions-with-side-effects" class="section-heading"><a href="#2-upcast-functions-with-side-effects" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Upcast Functions with Side Effects</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Side effects in upcast function</span><span class="w">
</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0525352395-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0525352395-2">(</span><span class="n">V1</span><span class="p" data-group-id="0525352395-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nf">log</span><span class="p" data-group-id="0525352395-3">(</span><span class="s">&quot;Upcasting event!&quot;</span><span class="p" data-group-id="0525352395-3">)</span><span class="p">,</span><span class="w">  </span><span class="c1">%% Side effect!</span><span class="w">
        </span><span class="nc">http</span><span class="p">:</span><span class="nf">post</span><span class="p" data-group-id="0525352395-4">(</span><span class="ss">webhook</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="0525352395-4">)</span><span class="p">,</span><span class="w">   </span><span class="c1">%% Network call!</span><span class="w">
        </span><span class="n">V1</span><span class="p" data-group-id="0525352395-5">#{</span><span class="p" data-group-id="0525352395-6">&lt;&lt;</span><span class="s">&quot;new_field&quot;</span><span class="p" data-group-id="0525352395-6">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fetch_from_db</span><span class="p" data-group-id="0525352395-7">(</span><span class="p" data-group-id="0525352395-7">)</span><span class="p" data-group-id="0525352395-5">}</span><span class="w">  </span><span class="c1">%% Database read!</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="0525352395-1">}</span><span class="w">

</span><span class="c1">%% GOOD: Pure transformation only</span><span class="w">
</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0525352395-8">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0525352395-9">(</span><span class="n">V1</span><span class="p" data-group-id="0525352395-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">V1</span><span class="p" data-group-id="0525352395-10">#{</span><span class="p" data-group-id="0525352395-11">&lt;&lt;</span><span class="s">&quot;new_field&quot;</span><span class="p" data-group-id="0525352395-11">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0525352395-12">&lt;&lt;</span><span class="s">&quot;default&quot;</span><span class="p" data-group-id="0525352395-12">&gt;&gt;</span><span class="p" data-group-id="0525352395-10">}</span><span class="w">  </span><span class="c1">%% Deterministic</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="0525352395-8">}</span></code></pre><h3 id="3-lossy-transformations-without-documentation" class="section-heading"><a href="#3-lossy-transformations-without-documentation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Lossy Transformations Without Documentation</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: Silent data loss</span><span class="w">
</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8561390720-1">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="8561390720-2">(</span><span class="n">V1</span><span class="p" data-group-id="8561390720-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Precision loss: cents truncated</span><span class="w">
        </span><span class="n">Cents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8561390720-3">(</span><span class="p" data-group-id="8561390720-4">&lt;&lt;</span><span class="s">&quot;amount_cents&quot;</span><span class="p" data-group-id="8561390720-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="8561390720-3">)</span><span class="p">,</span><span class="w">
        </span><span class="n">V1</span><span class="p" data-group-id="8561390720-5">#{</span><span class="p" data-group-id="8561390720-6">&lt;&lt;</span><span class="s">&quot;amount_dollars&quot;</span><span class="p" data-group-id="8561390720-6">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cents</span><span class="w"> </span><span class="ow">div</span><span class="w"> </span><span class="mi">100</span><span class="p" data-group-id="8561390720-5">}</span><span class="w">  </span><span class="c1">%% 199 cents → 1 dollar</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="8561390720-1">}</span><span class="w">

</span><span class="c1">%% GOOD: Document and minimize loss</span><span class="w">
</span><span class="c1">%% @doc Converts cents to dollars. Note: sub-dollar precision is preserved.</span><span class="w">
</span><span class="ss">upcast_from</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8561390720-7">#{</span><span class="w">
    </span><span class="mi">1</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="8561390720-8">(</span><span class="n">V1</span><span class="p" data-group-id="8561390720-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">Cents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8561390720-9">(</span><span class="p" data-group-id="8561390720-10">&lt;&lt;</span><span class="s">&quot;amount_cents&quot;</span><span class="p" data-group-id="8561390720-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V1</span><span class="p" data-group-id="8561390720-9">)</span><span class="p">,</span><span class="w">
        </span><span class="n">V1</span><span class="p" data-group-id="8561390720-11">#{</span><span class="p" data-group-id="8561390720-12">&lt;&lt;</span><span class="s">&quot;amount&quot;</span><span class="p" data-group-id="8561390720-12">&gt;&gt;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cents</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.0</span><span class="p" data-group-id="8561390720-11">}</span><span class="w">  </span><span class="c1">%% 199 cents → 1.99</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="8561390720-7">}</span></code></pre><h3 id="4-missing-schema-version-in-event" class="section-heading"><a href="#4-missing-schema-version-in-event" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Missing Schema Version in Event</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% BAD: No way to know which version this event uses</span><span class="w">
</span><span class="n">Event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7541508273-1">#{</span><span class="w">
    </span><span class="ss">event_type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-2">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="7541508273-2">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-3">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-4">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="7541508273-4">&gt;&gt;</span><span class="p" data-group-id="7541508273-3">}</span><span class="w">
</span><span class="p" data-group-id="7541508273-1">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% GOOD: Include schema version in metadata</span><span class="w">
</span><span class="n">Event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7541508273-5">#{</span><span class="w">
    </span><span class="ss">event_type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-6">&lt;&lt;</span><span class="s">&quot;UserCreated&quot;</span><span class="p" data-group-id="7541508273-6">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-7">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-8">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="7541508273-8">&gt;&gt;</span><span class="p" data-group-id="7541508273-7">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7541508273-9">#{</span><span class="ss">schema_version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7541508273-9">}</span><span class="w">
</span><span class="p" data-group-id="7541508273-5">}</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><ol><li><strong>Always increment versions</strong> - Never modify existing schema versions</li><li><strong>Keep upcast functions pure</strong> - No side effects, deterministic results</li><li><strong>Test upcast chains</strong> - Verify v1→v3 produces correct results</li><li><strong>Document breaking changes</strong> - Note when upcasting loses information</li><li><strong>Store version in event metadata</strong> - Makes debugging easier</li><li><strong>Register schemas at application startup</strong> - Ensure schemas are available before reads</li></ol><hr class="thin"/><h2 id="event-metadata-with-schema-version" class="section-heading"><a href="#event-metadata-with-schema-version" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Event Metadata with Schema Version</span></h2><p>Include version in event metadata for traceability:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%%--------------------------------------------------------------------</span><span class="w">
</span><span class="c1">%% This code runs in: YOUR APPLICATION</span><span class="w">
</span><span class="c1">%% Purpose: Include schema version when creating events</span><span class="w">
</span><span class="c1">%%--------------------------------------------------------------------</span><span class="w">

</span><span class="nf">create_event</span><span class="p" data-group-id="9535150429-1">(</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p" data-group-id="9535150429-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9535150429-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="9535150429-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">esdb_gater_api</span><span class="p">:</span><span class="nf">get_schema_version</span><span class="p" data-group-id="9535150429-3">(</span><span class="ss">my_store</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p" data-group-id="9535150429-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9535150429-4">#{</span><span class="w">
        </span><span class="ss">event_type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w">
        </span><span class="ss">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
        </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Metadata</span><span class="p" data-group-id="9535150429-5">#{</span><span class="ss">schema_version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="9535150429-5">}</span><span class="w">
    </span><span class="p" data-group-id="9535150429-4">}</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="when-not-to-use-schema-evolution" class="section-heading"><a href="#when-not-to-use-schema-evolution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">When NOT to Use Schema Evolution</span></h2><ul><li><strong>Breaking changes requiring re-processing</strong> - If you need to change the meaning of old events, consider creating a new event type instead</li><li><strong>Simple field additions</strong> - If all consumers can handle missing fields, you might not need formal schemas</li><li><strong>Performance-critical hot paths</strong> - Upcasting adds processing overhead</li></ul><hr class="thin"/><h2 id="related-guides" class="section-heading"><a href="#related-guides" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Related Guides</span></h2><ul><li><a href="event_sourcing.html">Event Sourcing</a> - Core concepts</li><li><a href="subscriptions.html">Subscriptions</a> - Events are upcasted on delivery</li><li><a href="snapshots.html">Snapshots</a> - Snapshots use current schema</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="causation.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Causation Tracking
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="stream_links.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Stream Links
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/reckon_gater/1.0.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/reckon_gater/1.0.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/reckon_gater/1.0.0/show/guides/schema_evolution.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="reckon_gater.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
